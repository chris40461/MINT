# ë°ì´í„° íë¦„ ì•„í‚¤í…ì²˜

## ğŸ“Œ ë¬¸ì„œ ëª©ì 

SKKU-INSIGHT ì‹œìŠ¤í…œ ë‚´ì˜ ë°ì´í„° íë¦„ì„ ì‹œê°í™”í•˜ê³ , ê° í•µì‹¬ ê¸°ëŠ¥ë³„ ë°ì´í„° ì²˜ë¦¬ ê³¼ì •ì„ ìƒì„¸íˆ ì„¤ëª…í•©ë‹ˆë‹¤.

---

## ğŸ”„ ì „ì²´ ë°ì´í„° íë¦„ ê°œìš”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  External    â”‚
â”‚ Data Sources â”‚ (pykrx, DART, Naver, MCP)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (1) Raw Data Collection
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Data     â”‚
â”‚   Service    â”‚ (ìˆ˜ì§‘, ê²€ì¦, ì •ì œ)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â†“ (2) Processing
  â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚         â”‚          â”‚          â”‚
  â†“         â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Trig â”‚ â”‚Analy   â”‚ â”‚Report  â”‚ â”‚Eval    â”‚
â”‚Svc  â”‚ â”‚Svc     â”‚ â”‚Svc     â”‚ â”‚Svc     â”‚
â””â”€â”€â”¬â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
   â”‚        â”‚          â”‚          â”‚
   â†“        â†“          â†“          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cache Layer (Redis) + DB (SQLite)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“ (3) Response
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        API Gateway           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
              â†“ (4) Rendering
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Frontend             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ í•µì‹¬ ê¸°ëŠ¥ë³„ ë°ì´í„° íë¦„

## 1. ê¸‰ë“±ì£¼ ê°ì§€ ë°ì´í„° íë¦„ (Trigger Detection)

### 1.1 ì˜¤ì „ íŠ¸ë¦¬ê±° (09:10 ì‹¤í–‰)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    APScheduler.add_job(run_morning_triggers, trigger="cron", hour=9, minute=10)
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: ë°ì´í„° ìˆ˜ì§‘ (Data Service)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    parallel_collect():
      â”œâ”€ pykrx.get_market_ohlcv_by_ticker(today) â†’ ë‹¹ì¼ OHLCV
      â”œâ”€ pykrx.get_market_ohlcv_by_ticker(yesterday) â†’ ì „ì¼ OHLCV
      â””â”€ pykrx.get_market_cap_by_ticker(today) â†’ ì‹œê°€ì´ì•¡
                         â†“
              DataFrame[í‹°ì»¤, ì‹œê°€, ê³ ê°€, ì €ê°€, ì¢…ê°€, ê±°ë˜ëŸ‰, ì‹œê°€ì´ì•¡]
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: ì§€í‘œ ê³„ì‚° (Metrics Calculator)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    calculate_indicators():
      â”œâ”€ ê±°ë˜ëŸ‰ì¦ê°€ìœ¨ = (í˜„ì¬ê±°ë˜ëŸ‰ / ì „ì¼ê±°ë˜ëŸ‰ - 1) Ã— 100
      â”œâ”€ ê°­ìƒìŠ¹ë¥  = (í˜„ì¬ì‹œê°€ / ì „ì¼ì¢…ê°€ - 1) Ã— 100
      â”œâ”€ ì¥ì¤‘ë“±ë½ë¥  = (í˜„ì¬ê°€ / ì‹œê°€ - 1) Ã— 100
      â””â”€ ê±°ë˜ëŒ€ê¸ˆ = ì¢…ê°€ Ã— ê±°ë˜ëŸ‰
                         â†“
        DataFrame + [ê±°ë˜ëŸ‰ì¦ê°€ìœ¨, ê°­ìƒìŠ¹ë¥ , ì¥ì¤‘ë“±ë½ë¥ , ê±°ë˜ëŒ€ê¸ˆ]
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: íŠ¸ë¦¬ê±°ë³„ í•„í„°ë§ & ì ìˆ˜í™”                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    parallel_triggers():
      â”œâ”€ Trigger 1: ê±°ë˜ëŸ‰ ê¸‰ì¦
      â”‚   â”œâ”€ í•„í„°: ê±°ë˜ëŸ‰ì¦ê°€ìœ¨ >= 30%, ê±°ë˜ëŒ€ê¸ˆ >= 5ì–µ
      â”‚   â”œâ”€ ì •ê·œí™”: min-max scaling (0-1)
      â”‚   â”œâ”€ ì ìˆ˜: ê±°ë˜ëŸ‰ì¦ê°€ìœ¨_norm*0.6 + ê±°ë˜ëŸ‰_norm*0.4
      â”‚   â””â”€ Top 3 ì„ ì •
      â”‚
      â”œâ”€ Trigger 2: ê°­ ìƒìŠ¹ ëª¨ë©˜í…€
      â”‚   â”œâ”€ í•„í„°: ê°­ìƒìŠ¹ë¥  >= 1%, ê±°ë˜ëŒ€ê¸ˆ >= 5ì–µ
      â”‚   â”œâ”€ ì ìˆ˜: ê°­ìƒìŠ¹ë¥ _norm*0.5 + ì¥ì¤‘ë“±ë½ë¥ _norm*0.3 + ê±°ë˜ëŒ€ê¸ˆ_norm*0.2
      â”‚   â””â”€ Top 3 ì„ ì •
      â”‚
      â””â”€ Trigger 3: ì‹œì´ ëŒ€ë¹„ ìê¸ˆìœ ì…
          â”œâ”€ í•„í„°: ê±°ë˜ëŒ€ê¸ˆ/ì‹œì´ ë¹„ìœ¨ é«˜
          â”œâ”€ ì ìˆ˜: ìê¸ˆìœ ì…ë¹„ìœ¨_norm*0.5 + ê±°ë˜ëŒ€ê¸ˆ_norm*0.5
          â””â”€ Top 3 ì„ ì •
                         â†“
        List[TriggerResult] (ìµœëŒ€ 9ê°œ ì¢…ëª©)
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: ì €ì¥ & ìºì‹±                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    save_results():
      â”œâ”€ DB.save(triggers_table, data)
      â”‚   â””â”€ INSERT INTO triggers (ticker, trigger_type, score, timestamp)
      â”‚
      â””â”€ Redis.set("triggers:morning:2025-11-06", data, ttl=3600)
          â””â”€ Key: "triggers:morning:{date}"
          â””â”€ TTL: 1ì‹œê°„
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: API ì‘ë‹µ                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    GET /api/v1/triggers?session=morning
      â†“
    Cache Hit â†’ ì¦‰ì‹œ ë°˜í™˜
    Cache Miss â†’ DB ì¡°íšŒ â†’ ë°˜í™˜
                         â†“
    Response JSON:
    {
      "session": "morning",
      "date": "2025-11-06",
      "triggers": [
        {
          "type": "volume_surge",
          "stocks": [
            {
              "ticker": "005930",
              "name": "ì‚¼ì„±ì „ì",
              "current_price": 75000,
              "change_rate": 3.5,
              "volume_increase": 45.2,
              "score": 0.92
            },
            ...
          ]
        },
        ...
      ]
    }
```

### 1.2 ì˜¤í›„ íŠ¸ë¦¬ê±° (15:30 ì‹¤í–‰)

ë™ì¼í•œ íë¦„ì´ì§€ë§Œ ë‹¤ë¥¸ íŠ¸ë¦¬ê±° ì ìš©:
- Trigger 4: ì¼ì¤‘ ìƒìŠ¹ë¥ 
- Trigger 5: ë§ˆê° ê°•ë„
- Trigger 6: íš¡ë³´ì£¼ ê±°ë˜ëŸ‰

---

## 2. ê¸°ì—… ë¶„ì„ ë°ì´í„° íë¦„ (Company Analysis)

### 2.1 ì‚¬ìš©ì ìš”ì²­ ë¶„ì„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ì‚¬ìš©ì ìš”ì²­                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    User: "ì‚¼ì„±ì „ì ë¶„ì„í•´ì¤˜"
      â†“
    Frontend: GET /api/v1/analysis/005930
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: ìºì‹œ ì¡°íšŒ (Cache Service)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    redis_key = "analysis:005930:2025-11-06"
    cached_data = Redis.get(redis_key)
                         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Cache Hit?    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚       â”‚
         YES â”‚       â”‚ NO
             â”‚       â”‚
             â†“       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Return â”‚  â”‚  Step 3: ë°ì´í„° ìˆ˜ì§‘  â”‚
    â”‚ Cache  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â†“
                parallel_collect():
                  â”œâ”€ Financial Data (DART API)
                  â”‚   â””â”€ get_financial_statement("005930")
                  â”‚       â†’ PER, PBR, ROE, ë¶€ì±„ë¹„ìœ¨, ë§¤ì¶œì•¡
                  â”‚
                  â”œâ”€ News Data (Naver/Firecrawl)
                  â”‚   â””â”€ crawl_news("ì‚¼ì„±ì „ì", days=7)
                  â”‚       â†’ List[{title, content, date, sentiment}]
                  â”‚
                  â”œâ”€ Technical Indicators (pykrx)
                  â”‚   â””â”€ calculate_technical("005930")
                  â”‚       â†’ RSI, MACD, ì´ë™í‰ê· (5, 20, 60ì¼)
                  â”‚
                  â””â”€ Stock Price (pykrx)
                      â””â”€ get_stock_price("005930", days=30)
                          â†’ DataFrame[ë‚ ì§œ, OHLCV]
                         â†“
            {
              "ticker": "005930",
              "name": "ì‚¼ì„±ì „ì",
              "current_price": 75000,
              "market_cap": 450000000000000,
              "financial": {
                "per": 12.5,
                "pbr": 1.8,
                "roe": 14.2,
                "debt_ratio": 45.3,
                "revenue": 300000000000000
              },
              "news": [
                {
                  "title": "ì‚¼ì„±ì „ì, ë°˜ë„ì²´ í˜¸í™©",
                  "sentiment": "positive",
                  "score": 0.85
                },
                ...
              ],
              "technical": {
                "rsi": 62.3,
                "macd": {"value": 120, "signal": 115},
                "ma_5": 74500,
                "ma_20": 73000,
                "ma_60": 71500
              }
            }
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: LLM ë¶„ì„ (Gemini Service)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    build_prompt():
      â†’ COMPANY_ANALYSIS_PROMPT.format(
          company_name="ì‚¼ì„±ì „ì",
          company_code="005930",
          current_price=75000,
          financial_data=...,
          news_summary=...,
          technical_indicators=...
        )
                         â†“
    call_gemini_api(prompt):
      â”œâ”€ Rate Limiter ì²´í¬
      â”œâ”€ POST https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent
      â”œâ”€ Headers: {"Authorization": f"Bearer {API_KEY}"}
      â””â”€ Body: {"contents": [{"parts": [{"text": prompt}]}]}
                         â†“
    Response (ì•½ 2-5ì´ˆ ì†Œìš”):
      {
        "candidates": [{
          "content": {
            "parts": [{
              "text": "## 1. ìš”ì•½\n- íˆ¬ìì˜ê²¬: ë§¤ìˆ˜\n- ëª©í‘œê°€: 85000ì›\n..."
            }]
          }
        }]
      }
                         â†“
    parse_llm_response():
      â†’ AnalysisResult(
          investment_opinion="ë§¤ìˆ˜",
          target_price=85000,
          key_insights=[...],
          financial_analysis="...",
          risk_factors=[...],
          investment_strategy="..."
        )
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: ì €ì¥ & ìºì‹±                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    save_analysis():
      â”œâ”€ DB.save(analysis_table, result)
      â”‚   â””â”€ INSERT INTO analysis (ticker, date, opinion, target_price, content)
      â”‚
      â””â”€ Redis.set("analysis:005930:2025-11-06", result, ttl=86400)
          â””â”€ TTL: 24ì‹œê°„
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: ì‘ë‹µ ë°˜í™˜                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    Response JSON:
    {
      "ticker": "005930",
      "name": "ì‚¼ì„±ì „ì",
      "date": "2025-11-06",
      "source": "llm",  // or "cache"
      "analysis": {
        "summary": {
          "opinion": "ë§¤ìˆ˜",
          "target_price": 85000,
          "current_price": 75000,
          "upside": 13.3
        },
        "financial": "...",
        "industry": "...",
        "risks": [...],
        "strategy": "..."
      },
      "metadata": {
        "generated_at": "2025-11-06T10:30:00",
        "ttl": 86400,
        "tokens_used": 1850
      }
    }
```

### 2.2 ì¬ë¶„ì„ íŠ¸ë¦¬ê±° (ìºì‹œ ë¬´íš¨í™”)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì¬ë¶„ì„ ì¡°ê±´                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    check_reanalysis_needed():
      â”œâ”€ ìºì‹œ ë§Œë£Œ (24ì‹œê°„ ê²½ê³¼)
      â”œâ”€ ì¤‘ìš” ê³µì‹œ ë°œìƒ (DART ì›¹í›…)
      â”œâ”€ ê¸‰ë“±/ê¸‰ë½ (10% ì´ìƒ ë³€ë™)
      â””â”€ ì‚¬ìš©ì ê°•ì œ ì¬ë¶„ì„ ìš”ì²­
                         â†“
        IF ì¬ë¶„ì„ í•„ìš”:
          â”œâ”€ Redis.delete("analysis:005930:*")
          â””â”€ ìœ„ Step 3ë¶€í„° ì¬ì‹¤í–‰
```

---

## 3. ì¥ ì‹œì‘/ë§ˆê° ë¦¬í¬íŠ¸ ë°ì´í„° íë¦„

### 3.1 ì¥ ì‹œì‘ ë¦¬í¬íŠ¸ (08:30)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ìŠ¤ì¼€ì¤„ëŸ¬ íŠ¸ë¦¬ê±°                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    APScheduler.add_job(generate_morning_report, trigger="cron", hour=8, minute=30)
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: ì‹œì¥ ë°ì´í„° ìˆ˜ì§‘                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    collect_market_data():
      â”œâ”€ ì „ì¼ í•œêµ­ ì‹œì¥
      â”‚   â””â”€ pykrx.get_index_ohlcv("KOSPI", yesterday)
      â”‚       â†’ KOSPI: 2500 (-0.5%)
      â”‚
      â”œâ”€ ì „ì¼ ë¯¸êµ­ ì‹œì¥ (ì›¹ í¬ë¡¤ë§/API)
      â”‚   â””â”€ crawl_us_market()
      â”‚       â†’ S&P500: +1.2%, NASDAQ: +1.5%
      â”‚
      â”œâ”€ í™˜ìœ¨
      â”‚   â””â”€ get_exchange_rate()
      â”‚       â†’ USD/KRW: 1320ì› (+5ì›)
      â”‚
      â””â”€ ì£¼ìš” ë‰´ìŠ¤
          â””â”€ crawl_overnight_news()
              â†’ List[{title, summary, impact}]
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: ì£¼ëª© ì¢…ëª© ì„ ì • (Metric ê¸°ë°˜)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    select_top_stocks():
      â”œâ”€ ëª¨ë“  ì¢…ëª© ì ìˆ˜ ê³„ì‚°
      â”‚   â””â”€ for each stock:
      â”‚       â”œâ”€ momentum_score = calculate_momentum(stock)  // 30%
      â”‚       â”‚   â””â”€ (D-1 ìˆ˜ìµë¥  * 0.5 + D-7 ìˆ˜ìµë¥  * 0.3 + D-30 ìˆ˜ìµë¥  * 0.2)
      â”‚       â”‚
      â”‚       â”œâ”€ volume_score = calculate_volume(stock)  // 25%
      â”‚       â”‚   â””â”€ (í˜„ì¬ ê±°ë˜ëŸ‰ / í‰ê·  ê±°ë˜ëŸ‰ - 1)
      â”‚       â”‚
      â”‚       â”œâ”€ sentiment_score = analyze_news_sentiment(stock)  // 20%
      â”‚       â”‚   â””â”€ LLM.analyze(recent_news) â†’ score (0-1)
      â”‚       â”‚
      â”‚       â”œâ”€ technical_score = calculate_technical(stock)  // 15%
      â”‚       â”‚   â””â”€ (RSI ì •ê·œí™” + MACD ì •ê·œí™”) / 2
      â”‚       â”‚
      â”‚       â””â”€ financial_score = calculate_financial(stock)  // 10%
      â”‚           â””â”€ (ROE * 0.5 + ë¶€ì±„ë¹„ìœ¨ ì—­ìˆ˜ * 0.3 + ë§¤ì¶œì„±ì¥ë¥  * 0.2)
      â”‚
      â””â”€ total_score = (
          momentum * 0.30 +
          volume * 0.25 +
          sentiment * 0.20 +
          technical * 0.15 +
          financial * 0.10
        )
                         â†“
    Top 5 ì¢…ëª© ì„ ì • (ì ìˆ˜ ê¸°ì¤€ ì •ë ¬)
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: LLM ë¦¬í¬íŠ¸ ìƒì„±                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    build_market_report_prompt():
      â†’ MARKET_OPENING_PROMPT.format(
          kospi_data=...,
          us_market=...,
          exchange_rate=...,
          top_stocks=...,
          news=...
        )
                         â†“
    call_gemini_api(prompt):
      â†’ Gemini Response:
        "## 1. ì‹œì¥ ì „ë§\n
         ë¯¸êµ­ ì¦ì‹œ ìƒìŠ¹ê³¼ ì›í™” ì•½ì„¸ë¡œ ìˆ˜ì¶œì£¼ ì¤‘ì‹¬ ê°•ì„¸ ì˜ˆìƒ...\n
         \n
         ## 2. ì£¼ëª© ì¢…ëª© Top 5\n
         1. ì‚¼ì„±ì „ì (005930) - ë°˜ë„ì²´ í˜¸í™© + ê¸°ìˆ ì  ëŒíŒŒ\n
         2. SKí•˜ì´ë‹‰ìŠ¤ (000660) - HBM ìˆ˜ìš” ê¸‰ì¦\n
         ...\n
         \n
         ## 3. ì„¹í„° ë¶„ì„\n
         ê°•ì„¸: IT, ë°˜ë„ì²´, ìë™ì°¨\n
         ì•½ì„¸: ê±´ì„¤, ì¦ê¶Œ, ì€í–‰\n
         \n
         ## 4. íˆ¬ì ì „ëµ\n
         ë³€ë™ì„± í™•ëŒ€ ì˜ˆìƒ, ë¶„í•  ë§¤ìˆ˜ ê¶Œì¥..."
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: ì €ì¥ & ìºì‹±                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    save_report():
      â”œâ”€ DB.save(reports_table, report)
      â””â”€ Redis.set("report:morning:2025-11-06", report, ttl=43200)  // 12ì‹œê°„
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 6: í”„ë¡ íŠ¸ì—”ë“œ ì•Œë¦¼                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    notify_frontend():
      â””â”€ WebSocket push notification
          â†’ "ìƒˆë¡œìš´ ì¥ ì‹œì‘ ë¦¬í¬íŠ¸ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤"
```

### 3.2 ì¥ ë§ˆê° ë¦¬í¬íŠ¸ (15:40)

ìœ ì‚¬í•œ íë¦„ì´ì§€ë§Œ:
- ê¸‰ë“±ì£¼ ìƒì„¸ ë¶„ì„ í¬í•¨
- ë‹¹ì¼ ì‹œì¥ ìš”ì•½
- ë‚´ì¼ ì „ëµ ì œì‹œ

---

## 4. í‰ê°€ ì‹œìŠ¤í…œ ë°ì´í„° íë¦„

### 4.1 ì˜ˆì¸¡ ì •í™•ë„ ì¶”ì 

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: ì¶”ì²œ ì¢…ëª© ì €ì¥ (ë¶„ì„/ë¦¬í¬íŠ¸ ìƒì„± ì‹œ)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    save_recommendation():
      â””â”€ DB.INSERT INTO recommendations (
          ticker, date, opinion, target_price, current_price, source
        )
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: ì¼ì¼ ë°°ì¹˜ (ìµì¼ ì¥ ë§ˆê° í›„)                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    APScheduler.add_job(evaluate_predictions, trigger="cron", hour=16, minute=0)
                         â†“
    evaluate_d_plus_1():
      â”œâ”€ ì „ì¼ ì¶”ì²œ ì¢…ëª© ì¡°íšŒ
      â”‚   â””â”€ SELECT * FROM recommendations WHERE date = yesterday
      â”‚
      â”œâ”€ ì‹¤ì œ ìˆ˜ìµë¥  ê³„ì‚°
      â”‚   â””â”€ for each recommendation:
      â”‚       actual_return = (today_close / yesterday_close - 1) * 100
      â”‚
      â”œâ”€ ì˜ˆì¸¡ vs ì‹¤ì œ ë¹„êµ
      â”‚   â””â”€ IF opinion == "ë§¤ìˆ˜" AND actual_return > 0:
      â”‚         hit = True
      â”‚       ELSE:
      â”‚         hit = False
      â”‚
      â””â”€ í†µê³„ ì €ì¥
          â””â”€ DB.UPDATE recommendations SET
              actual_return=..., hit=..., evaluated_at=NOW()
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: ì£¼ê°„ í‰ê°€ ë¦¬í¬íŠ¸ ìƒì„±                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    generate_evaluation_report():
      â”œâ”€ ì§€ë‚œ 7ì¼ ë°ì´í„° ì§‘ê³„
      â”‚   â””â”€ SELECT
      â”‚       COUNT(*) as total,
      â”‚       SUM(hit) as hits,
      â”‚       AVG(actual_return) as avg_return
      â”‚     FROM recommendations
      â”‚     WHERE date >= DATE_SUB(NOW(), INTERVAL 7 DAY)
      â”‚
      â””â”€ í‰ê°€ ì§€í‘œ ê³„ì‚°
          â”œâ”€ win_rate = hits / total  // ìŠ¹ë¥ 
          â”œâ”€ avg_return = SUM(actual_return) / total  // í‰ê·  ìˆ˜ìµë¥ 
          â””â”€ sharpe_ratio = avg_return / std_dev(returns)  // ìƒ¤í”„ ë¹„ìœ¨
                         â†“
    Response:
    {
      "period": "2025-11-01 ~ 2025-11-07",
      "metrics": {
        "total_recommendations": 42,
        "win_rate": 0.58,  // 58%
        "avg_return": 2.3,  // 2.3%
        "sharpe_ratio": 1.25
      },
      "by_source": {
        "analysis": {"win_rate": 0.62, "count": 20},
        "morning_report": {"win_rate": 0.54, "count": 15},
        "afternoon_report": {"win_rate": 0.57, "count": 7}
      }
    }
```

---

## 5. ìºì‹± ë ˆì´ì–´ ë°ì´í„° íë¦„

### 5.1 Redis ìºì‹œ í‚¤ êµ¬ì¡°

```
# ê¸‰ë“±ì£¼ íŠ¸ë¦¬ê±°
triggers:morning:{date}     TTL: 1ì‹œê°„ (3600ì´ˆ)
triggers:afternoon:{date}   TTL: 1ì‹œê°„

# ê¸°ì—… ë¶„ì„
analysis:{ticker}:{date}    TTL: 24ì‹œê°„ (86400ì´ˆ)

# ì¥ ë¦¬í¬íŠ¸
report:morning:{date}       TTL: 12ì‹œê°„ (43200ì´ˆ)
report:afternoon:{date}     TTL: 12ì‹œê°„

# ì¢…ëª© ê¸°ë³¸ ì •ë³´
stock:info:{ticker}         TTL: 7ì¼ (604800ì´ˆ)

# LLM Rate Limiting
llm:rate_limit:{minute}     TTL: 60ì´ˆ
```

### 5.2 ìºì‹œ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ìš”ì²­                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
    cache_key = generate_key(request)
    cached_data = Redis.get(cache_key)
                         â†“
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚   Cache Hit?    â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚       â”‚
         YES â”‚       â”‚ NO
             â”‚       â”‚
             â†“       â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Return     â”‚  â”‚ Execute       â”‚
    â”‚ from Cache â”‚  â”‚ Business Logicâ”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â†“
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚ Save to Cache â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
                    Redis.set(cache_key, data, ttl)
```

### 5.3 ìºì‹œ ë¬´íš¨í™” ì „ëµ

```python
# ì¡°ê±´ë¶€ ë¬´íš¨í™”
def invalidate_cache_if_needed(ticker: str):
    """
    ìºì‹œ ë¬´íš¨í™” ì¡°ê±´:
    1. ì¤‘ìš” ê³µì‹œ ë°œìƒ
    2. ê¸‰ë“±/ê¸‰ë½ (10% ì´ìƒ)
    3. ì‹œì¥ ì‹œê°„ ì™¸ ì—…ë°ì´íŠ¸
    """
    if detect_important_announcement(ticker):
        Redis.delete(f"analysis:{ticker}:*")

    if abs(price_change_rate) >= 10:
        Redis.delete(f"analysis:{ticker}:*")

# ì •ê¸° ë¬´íš¨í™”
def scheduled_cache_cleanup():
    """
    ë§¤ì¼ ìì • ì‹¤í–‰:
    - ë§Œë£Œëœ ìºì‹œ ì •ë¦¬
    - ë©”ëª¨ë¦¬ ìµœì í™”
    """
    Redis.execute_command("MEMORY PURGE")
```

---

## 6. ì—ëŸ¬ ì²˜ë¦¬ ë° Fallback íë¦„

### 6.1 ë°ì´í„° ìˆ˜ì§‘ ì‹¤íŒ¨

```
pykrx.get_market_ohlcv_by_ticker(date)
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Success?â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚ NO
         â†“
    retry_logic (max=3, delay=2s):
      â”œâ”€ Attempt 1 â†’ Fail
      â”œâ”€ Attempt 2 â†’ Fail
      â””â”€ Attempt 3 â†’ Fail
         â†“
    fallback_options:
      â”œâ”€ Option 1: MCP kospi_kosdaq ì„œë²„
      â”œâ”€ Option 2: ìºì‹œëœ ì „ì¼ ë°ì´í„° ì‚¬ìš©
      â””â”€ Option 3: ì—ëŸ¬ ë¡œê·¸ + ì‚¬ìš©ì ì•Œë¦¼
```

### 6.2 LLM API ì‹¤íŒ¨

```
Gemini.generate(prompt)
    â†“
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Success?â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚ NO (Rate Limit / Timeout)
         â†“
    handle_llm_error():
      â”œâ”€ Rate Limit (429):
      â”‚   â””â”€ wait(60s) + retry
      â”‚
      â”œâ”€ Timeout (504):
      â”‚   â””â”€ reduce_prompt_size() + retry
      â”‚
      â””â”€ Other Error:
          â””â”€ use_cached_similar_analysis()
              OR return_rule_based_analysis()
```

---

## ğŸ“Š ì„±ëŠ¥ ìµœì í™” í¬ì¸íŠ¸

### ë³‘ë ¬ ì²˜ë¦¬
```python
# ë°ì´í„° ìˆ˜ì§‘ ë³‘ë ¬í™”
async def parallel_data_collection():
    tasks = [
        collect_ohlcv(),
        collect_financial(),
        collect_news()
    ]
    results = await asyncio.gather(*tasks)
```

### ë°°ì¹˜ ì²˜ë¦¬
```python
# ì—¬ëŸ¬ ì¢…ëª© í•œë²ˆì— ë¶„ì„
def batch_analyze(tickers: List[str]):
    # DB ì¿¼ë¦¬ 1íšŒë¡œ ì¤„ì´ê¸°
    data = DB.query_in(tickers)

    # LLM 1íšŒ í˜¸ì¶œë¡œ ì—¬ëŸ¬ ì¢…ëª© ë¶„ì„
    prompt = build_batch_prompt(data)
    result = LLM.generate(prompt)
```

### ì¸ë±ì‹±
```sql
-- ìì£¼ ì¡°íšŒë˜ëŠ” ì»¬ëŸ¼ ì¸ë±ìŠ¤
CREATE INDEX idx_triggers_date ON triggers(date);
CREATE INDEX idx_analysis_ticker_date ON analysis(ticker, date);
CREATE INDEX idx_recommendations_date ON recommendations(date);
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [FastAPI Async](https://fastapi.tiangolo.com/async/)
- [Redis Caching Strategies](https://redis.io/docs/manual/patterns/)
- [pykrx Documentation](https://github.com/sharebook-kr/pykrx)

---

**ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸**: 2025-11-06
**ì‘ì„±ì**: SKKU-INSIGHT ê°œë°œíŒ€
